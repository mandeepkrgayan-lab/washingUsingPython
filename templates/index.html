<!DOCTYPE html>
<html>
<head>
    <title>WashSmart</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</head>
<body>
    <div class="container">
        <h1>WashSmart</h1>
        <input type="text" id="phone" placeholder="Enter your phone number">
        <button onclick="check()">Check</button>
        <div id="status"></div>
    </div>

    <script>
        function check() {
            const phone = document.getElementById('phone').value;
            document.getElementById('status').innerHTML = 'Checking...';

            fetch('/check', {
                method: 'POST',
                body: new URLSearchParams({phone})
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'active') {
                    document.getElementById('status').innerHTML = `<button onclick="turnOn()">Turn On</button>`;
                } else if (data.status === 'expired' || data.status === 'new') {
                    showPlans();
                } else if (data.status === 'inUse') {
                    document.getElementById('status').innerHTML = `Another user is using it. Time remaining: ${data.remaining} min`;
                }
            });
        }

        function showPlans() {
            document.getElementById('status').innerHTML = `
                <button onclick="pay(79,1)">Daily - ₹79</button>
                <button onclick="pay(119,7)">Weekly - ₹119</button>
                <button onclick="pay(199,30)">Monthly - ₹199</button>
            `;
        }

        function pay(amount, days) {
            const options = {
                key: "rzp_test_NhQFMV57BI5o45",
                amount: amount * 100,
                currency: "INR",
                name: "WashSmart",
                description: "Subscription",
                handler: function () {
                    const phone = document.getElementById('phone').value;
                    fetch('/update', {
                        method: 'POST',
                        body: new URLSearchParams({phone, days})
                    }).then(res => res.json())
                      .then(() => check());
                },
                prefill: {
                    contact: document.getElementById('phone').value
                },
                theme: {
                    color: "#3399cc"
                }
            };
            const rzp = new Razorpay(options);
            rzp.open();
        }

        function turnOn() {
            fetch('/turnon', {
                method: 'POST'
            })
            .then(res => res.json())
            .then(data => {
                document.getElementById('status').innerHTML = 'Machine turned on for 30 minutes!';
                fetch(data.url); // silently open the plug URL
            });
        }
    </script>
</body>
</html>
